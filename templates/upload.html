<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/upload.css">
    <title>GWS - Upload</title>
</head>
<body>
    <div id="topo"><h1 id="titulo">Gray Wolf System.</h1></div>

    <form action="/graywolf-upload-file" method="POST" enctype="multipart/form-data">
        <div id="upload-caixa">
            <LABEl>Escolha onde salvar o arquivo:</LABEl>
            <select name="chooseFile" id="chooseFile" required>
                <option value="">Escolha a categoria</option>
                <option value="audio">Audio</option>
                <option value="documents">Documentos</option>
                <option value="image">Imagens</option>
                <option value="text">Texto</option>
                <option value="video">Videos</option>
                <option value="geral">Geral</option>
            </select>

            <label>Subcategoria:</label>
            <select name="subCategory" id="subCategory" required>
                <option value="">Selecione uma subcategoria</option>
            </select>

            <input type="file" name="file" id="file" required>
            <progress id="uploadProgress" value="0" max="100" style="width: 100%; display: none;"></progress>
            <p id="uploadStatus" style="text-align:center; font-weight: bold;"></p>
            <button type="submit">Enviar</button>
        </div>
    </form>
    <div id="botoes-caixa">
        <form action="/graywolf-back" method="GET">
            <button id="backButton" type="submit">Voltar para HomePage.</button>
        </form>
    </div>
    <div id="roda_pe">
        <p>Copyright GrayWolf 2025.</p>
    </div>
        <script>
        const subCategories = {
            audio: ["audio_no_category", "music", "podcast"],
            documents: ["documents_no_category", "excel", "powerpoint", "word", "pdf"],
            image: ["image_no_category", "photo", "screenshots"],
            text: ["text_no_category", "list", "note", "script"],
            video: ["video_no_category", "serie", "movie"],
            geral: ["sem_subcategoria"]
        };

        document.getElementById("chooseFile").addEventListener("change", function () {
            const selected = this.value;
            const subSelect = document.getElementById("subCategory");
            subSelect.innerHTML = "";

            if (subCategories[selected]) {
                subCategories[selected].forEach(sub => {
                    const opt = document.createElement("option");
                    opt.value = sub;
                    opt.text = sub.charAt(0).toUpperCase() + sub.slice(1);
                    subSelect.appendChild(opt);
                });
            } else {
                const opt = document.createElement("option");
                opt.value = "";
                opt.text = "Nenhuma subcategoria";
                subSelect.appendChild(opt);
            }
        });

        // Interceptar envio do formulário e usar AJAX
        const form = document.querySelector("form");
        form.addEventListener("submit", function (e) {
            e.preventDefault(); // impede envio tradicional

            const fileInput = document.getElementById("file");
            const chooseFile = document.getElementById("chooseFile").value;
            const subCategory = document.getElementById("subCategory").value;
            const progress = document.getElementById("uploadProgress");
            const status = document.getElementById("uploadStatus");

            if (!fileInput.files.length) {
                alert("Selecione um arquivo.");
                return;
            }

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            formData.append("chooseFile", chooseFile);
            formData.append("subCategory", subCategory);

            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/graywolf-upload-file", true);

            // Evento de progresso
            xhr.upload.onprogress = function (event) {
                if (event.lengthComputable) {
                    const percent = Math.round((event.loaded / event.total) * 100);
                    progress.style.display = "block";
                    progress.value = percent;
                    status.textContent = `Enviando: ${percent}%`;
                }
            };

            // Evento de fim
            xhr.onload = function () {
                if (xhr.status === 200) {
                    status.textContent = "Upload concluído com sucesso!";
                } else {
                    status.textContent = "Erro no upload.";
                }
            };

            xhr.onerror = function () {
                status.textContent = "Erro de conexão ao enviar.";
            };

            xhr.send(formData);
        });
    </script>

</body>
</html>